FROM registry.fedoraproject.org/fedora:41

# 1. Base Setup (User, Sudo, Common Utils)
RUN dnf install -y 'dnf-command(config-manager)' \
    && dnf config-manager addrepo --from-repofile=https://cli.github.com/packages/rpm/gh-cli.repo \
    && dnf install -y \
        zsh \
        sudo \
        which \
        man-db \
        procps-ng \
        findutils \
        iputils \
        hostname \
        wget \
        git \
        gh \
        skopeo \
        jq \
    && dnf clean all

# 1b. Install yq (Required for configure.sh)
ARG YQ_VERSION="4.50.1"
RUN ARCH=$(uname -m) && \
    case "$ARCH" in \
        x86_64)  BIN_ARCH="amd64" ;; \
        aarch64) BIN_ARCH="arm64" ;; \
        *) echo "Unsupported architecture: $ARCH"; exit 1 ;; \
    esac && \
    curl -sSL "https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_${BIN_ARCH}" -o /usr/bin/yq && \
    chmod +x /usr/bin/yq

# 2. Create the 'ai' user
RUN useradd -m -s /bin/zsh -u 1000 ai \
    && echo "ai ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/ai \
    # Starship & Bindings
    && echo 'eval "$(starship init zsh)"' >> /home/ai/.zshrc \
    && echo 'bindkey "^[[H" beginning-of-line' >> /home/ai/.zshrc \
    && echo 'bindkey "^[[F" end-of-line' >> /home/ai/.zshrc \
    && echo 'bindkey "^[[3~" delete-char' >> /home/ai/.zshrc \
    && echo 'bindkey "^[[1;5C" forward-word' >> /home/ai/.zshrc \
    && echo 'bindkey "^[[1;5D" backward-word' >> /home/ai/.zshrc

# 3. Git Credential Fix
RUN git config --system credential.helper store

# 4. Setup Entrypoint
COPY configure.sh /usr/local/bin/configure.sh
RUN chmod +x /usr/local/bin/configure.sh

# 5. Default Config
RUN mkdir -p /etc/ai-shell
COPY config.default.yaml /etc/ai-shell/config.yaml

# 6. Starship Installation (Common enough to be in base?)
# Let's put it in base so all profiles look good.
RUN curl -sS https://starship.rs/install.sh | sh -s -- -y >/dev/null

ENTRYPOINT ["/usr/local/bin/configure.sh"]
CMD ["/bin/zsh"]
