FROM localhost/ai-shell-base:latest

# 1. Install Tools (gh, skopeo, jq, sqlite, kubectl)
RUN dnf install -y 'dnf-command(config-manager)' \
    && dnf config-manager addrepo --from-repofile=https://cli.github.com/packages/rpm/gh-cli.repo \
    && dnf install -y \
        gh \
        skopeo \
        jq \
        vim \
        neovim \
        ripgrep \
        fd-find \
        nodejs \
        python3 \
        python3-pip \
        golang \
        sqlite \
        kubernetes-client \
    && dnf clean all

# 2. Install AI CLI tools (Claude, Gemini)
RUN npm install -g @anthropic-ai/claude-code @google/gemini-cli

# 3. Install Manual Binaries (ORAS, Glab, YQ, Cosign)
ARG ORAS_VERSION="1.3.0"
ARG GLAB_VERSION="1.80.4"
ARG YQ_VERSION="4.50.1"
ARG COSIGN_V2_VERSION="2.6.1"
ARG COSIGN_V3_VERSION="3.0.3"

RUN ARCH=$(uname -m) && \
    case "$ARCH" in \
        x86_64)  BIN_ARCH="amd64" ;; \
        aarch64) BIN_ARCH="arm64" ;; \
        *) echo "Unsupported architecture: $ARCH"; exit 1 ;; \
    esac && \
    # ORAS
    curl -sSL "https://github.com/oras-project/oras/releases/download/v${ORAS_VERSION}/oras_${ORAS_VERSION}_linux_${BIN_ARCH}.tar.gz" -o oras.tar.gz && \
    mkdir -p /usr/local/bin/ && \
    tar -zxf oras.tar.gz -C /usr/local/bin/ oras && \
    rm oras.tar.gz && \
    # Glab
    curl -sSL "https://gitlab.com/gitlab-org/cli/-/releases/v${GLAB_VERSION}/downloads/glab_${GLAB_VERSION}_linux_${BIN_ARCH}.tar.gz" -o glab.tar.gz && \
    tar -zxf glab.tar.gz -C /usr/local/bin/ bin/glab && \
    rm glab.tar.gz && \
    # YQ
    curl -sSL "https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_${BIN_ARCH}" -o /usr/bin/yq && \
    chmod +x /usr/bin/yq && \
    # Cosign
    curl -sSL "https://github.com/sigstore/cosign/releases/download/v${COSIGN_V2_VERSION}/cosign-linux-${BIN_ARCH}" -o /usr/local/bin/cosign-v2 && \
    chmod +x /usr/local/bin/cosign-v2 && \
    curl -sSL "https://github.com/sigstore/cosign/releases/download/v${COSIGN_V3_VERSION}/cosign-linux-${BIN_ARCH}" -o /usr/local/bin/cosign-v3 && \
    chmod +x /usr/local/bin/cosign-v3 && \
    ln -s /usr/local/bin/cosign-v2 /usr/local/bin/cosign
